/** https://github.com/guoguo12/url-shortener/ */

function onOpen(){DocumentApp.getUi().createAddonMenu().addItem("Get document link","showDocDialog").addItem("Shorten selected URL","showSelectedDialog").addItem("Shorten and replace selected URL","shortenAndReplace").addToUi()}function onInstall(){onOpen()}function showDocDialog(){var e=HtmlService.createHtmlOutputFromFile("DocDialog");e.setHeight(80);e.setWidth(400);DocumentApp.getUi().showModalDialog(e,"Get document link")}function showSelectedDialog(){var e=HtmlService.createHtmlOutputFromFile("SelectedDialog");e.setHeight(175);e.setWidth(470);DocumentApp.getUi().showModalDialog(e,"Shorten selected URL")}function shortenAndReplace(){var e=shortenSelUrl();if(e){replaceSelectedInSelection(e[0],e[1])}}function shortenDocUrl(){var e=PropertiesService.getDocumentProperties();var t=e.getProperty("short-url");if(!t){var n=DocumentApp.getActiveDocument().getUrl();t=shorten(n);e.setProperty("short-url",t)}return t}function shortenSelUrl(){var e=DocumentApp.getActiveDocument().getSelection();if(!e){showError("Nothing is selected.");return}var t=e.getRangeElements();if(t.length<1){showError("No element selected.");return}if(t.length>1){showError("Too many elements are selected.");return}var n=t[0];var r=n.getElement();try{r.editAsText()}catch(i){showError("Selection is not a valid URL.");return}var s=trim(getTextFromElement(r,n));if(!s||s.indexOf(" ")!=-1||s.indexOf("\\")!=-1||s.indexOf(".")==-1){showError("Selection does not appear to be a valid URL.");return}if(s.indexOf("goo.gl")!=-1){showError("This URL cannot be shortened.");return}var o=shorten(s);return[s,o]}function shorten(e){try{var t=UrlShortener.Url.insert({longUrl:e})}catch(n){throw'URL Shortener service request failed (reason: "'+n+'")'}if(t.id){return t.id}else{throw"URL Shortener service request failed"}}function replaceSelectedInSelection(e,t){var n=DocumentApp.getActiveDocument().getSelection();if(!n){return}var r=n.getRangeElements();for(var i=0;i<r.length;i++){try{var s=r[i].getElement().editAsText();s.replaceText(escape(e),t)}catch(o){}}}function showWarning(e){var t=DocumentApp.getUi();var n=t.alert("Warning",e,t.ButtonSet.YES_NO);return n==t.Button.YES}function showError(e){var t=DocumentApp.getUi();t.alert("Error",e,t.ButtonSet.OK)}function getTextFromElement(e,t){var n=t.getStartOffset();var r=t.getEndOffsetInclusive()+1;return e.editAsText().getText().substring(n,r)}function isLikelyValidUrl(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&:\/~+#-]*[\w@?^=%&\/~+#-])?/;var n=e.match(t);return n!=null&&e==n[0]}function trim(e){return e.replace(/^\s+|\s+$/g,"")}function escape(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}