/** https://github.com/guoguo12/url-shortener/ */

function onOpen(){DocumentApp.getUi().createAddonMenu().addItem("Get document link","showDocDialog").addItem("Shorten selected URL","showSelectedDialog").addItem("Shorten and replace selected URL","shortenAndReplace").addToUi()}function onInstall(){onOpen()}function showDocDialog(){var e=HtmlService.createHtmlOutputFromFile("DocDialog").setSandboxMode(HtmlService.SandboxMode.IFRAME);e.setHeight(88),e.setWidth(375),DocumentApp.getUi().showModalDialog(e,"Get document link")}function showSelectedDialog(){var e=HtmlService.createHtmlOutputFromFile("SelectedDialog").setSandboxMode(HtmlService.SandboxMode.IFRAME);e.setHeight(206),e.setWidth(479),DocumentApp.getUi().showModalDialog(e,"Shorten selected URL")}function shortenAndReplace(){var e=shortenSelUrl();e&&replaceSelectedInSelection(e[0],e[1])}function shortenDocUrl(){var e=PropertiesService.getDocumentProperties(),t=e.getProperty("short-url");if(!t){var r=DocumentApp.getActiveDocument().getUrl();t=shorten(r),e.setProperty("short-url",t)}return t}function shortenSelUrl(){var e=DocumentApp.getActiveDocument().getSelection();if(!e)return void showError("Nothing is selected.");var t=e.getRangeElements();if(t.length<1)return void showError("No element selected.");if(t.length>1)return void showError("Too many elements are selected.");var r=t[0],n=r.getElement();try{n.editAsText()}catch(o){return void showError("Selection is not a valid URL.")}var i=trim(getTextFromElement(n,r));if(!i||-1!=i.indexOf(" ")||-1!=i.indexOf("\\")||-1==i.indexOf("."))return void showError("Selection does not appear to be a valid URL.");if(-1!=i.indexOf("goo.gl"))return void showError("This URL cannot be shortened.");var l=shorten(i);return[i,l]}function shorten(e){try{var t=UrlShortener.Url.insert({longUrl:e})}catch(r){throw'URL Shortener service request failed (reason: "'+r+'")'}if(t.id)return t.id;throw"URL Shortener service request failed"}function replaceSelectedInSelection(e,t){var r=DocumentApp.getActiveDocument().getSelection();if(r)for(var n=r.getRangeElements(),o=0;o<n.length;o++)try{var i=n[o].getElement().editAsText();i.replaceText(escape(e),t)}catch(l){}}function showWarning(e){var t=DocumentApp.getUi(),r=t.alert("Warning",e,t.ButtonSet.YES_NO);return r==t.Button.YES}function showError(e){var t=DocumentApp.getUi();t.alert("Error",e,t.ButtonSet.OK)}function getTextFromElement(e,t){var r=t.getStartOffset(),n=t.getEndOffsetInclusive()+1;return e.editAsText().getText().substring(r,n)}function isLikelyValidUrl(e){var t=/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/,r=e.match(t);return null!=r&&e==r[0]}function trim(e){return e.replace(/^\s+|\s+$/g,"")}function escape(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}
